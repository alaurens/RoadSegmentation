# Road Segmentation Project

### Introduction

During the second half of the autumn semester 2018, during the course of Machine learning at EPFL we worked on a road segmentation project.
In this project, we are given a set of satellite images and for each of these images a masks where the roads are labeled. The goal is to be able to correctly predict the mask of a set of test images and evaluate this prediction using the F1 score metric.

Using data augmentation and U-nets we were able to achieve a F1 score of 0.903 on the crowdAI competition effectively ranking 3rd
Our final submission is done by alaurens and has ID number 24871

### Structure of the submission

The structure of our project is the following:
```
.
├── data
│   ├── groundtruth
│   ├── images
│   ├── test_set_images
│   │   ├── test_1
│   │   ├── test_…
│   │   └── test_50
│   └── validation
├── logs
├── src
│   ├── data_process.py
│   ├── generator.py
│   ├── image_process.py
│   ├── logs_process.py
│   ├── mask_to_submission.py
│   ├── model.py
│   ├── neural_net_blocks.py
│   ├── paths_to_data.py
│   ├── plotting.ipynb
│   ├── run.py
│   ├── train_model.py
│   └── visualization.py
├── submission
└── weights
```
In the `data` folder we have the data used for the project. The `groundtruth` folder contains the masks of the training images. The `images` folder contains the images used for training the `test_set_images` contains 50 folders each containing a different test image. Please note that we do note modify these folders from the original folders that we downloaded. The `validation` folder contains images that are used for validation. We move some images from the `images` folder to the `validation folder`

###### !!!!!!!!!!!!! If you wish to train the model you must take at least one image from `images` and move it to `validation`

The `logs` folder is used to store the logs and the weights during training

The `submission` folder is used to store the submissions for crowdAI

The `weights` folder contains the weights using to predict the data

The `scr` folder contains the source code to the project. It is composed of:
* `data_process.py`: This file contains all function relative to the processing of the images to feed to the U-net
* `generator.py`: This file contains the generators function of train, test and validation data used to feed the U-net.
* `image_process.py`: This file contains all functions relative to image processing in general and not specifically for this project.
* `logs_process`: This file contains all functions relative to obtaining and processing the logs generated by the training
* `mask_to_submission`: This file contains functions used for submission, given to us by the professor
* `model.py`: This file contains the definition of the 2 possible version of the U-net, one with 3  pooling layers and one with 4.
* `neural_net_blocks.py`: This file contains the different building blocks used to build the larger neural network
* `paths_to_data` : This file contains the different paths to access the data of the project.
* `plotting.ipynb`: Jupyter notebook to generate an image of the report
* `run.py` : This script should be run to recreate the submission file used for the crowdAI competition
* `train_model.py`: This script should be run if you wish to train the neural network
* `visualization.py`: This file contains function relative to showing the different images for the report


### Packages requirements
In order to make the different scripts run you must install all packages listed in `requirements.txt`.

In order to install all the packages please use the command :

`pip install -r requirements.txt`

We recommend the use of virtual environments in order to test the code, see: [**Virtualenvs**](https://www.youtube.com/watch?v=N5vscPTWKOk&ab_channel=CoreySchafer)

###### !!!!!!!!! In order for this to work you must be running a version 3.5 or 3.6 of python. 3.7 is not compatible with tensorflow

### Training the U-net

To train the neural network, you must launch the script. `train_model.py`. **The script must be launched from the src folder**

Warning, training of the neural networks takes approximately 5 to 10 hours to train on a NVIDIA TESLA P100 GPU available on google cloud. Training the neural network on a personal computer is not feasible.

### Creating the submission for crowdAI

To create the submission you must first download the `hdf5` file containing the weights of the neural network from [**this link**](https://drive.google.com/open?id=1AB4cjfnAnr3rNiNtIChgtamc1Cv9T8Cm) and place it into the `weights` folder.

Then, please run the `run.py` script located in the `src` folder. **The script must be launched from the src folder.** This took approx. 20 min on my personal computer.

The resulting submission will be located in the folder `submission` under the name: `weights342.csv`

### Training and then using the trained weights

If you which to train the U-net and then used the train submission you must first train the U-net using `train_model.py` then, you must select the desired `weightsNUM.hdf5` files from the `logs folder`
